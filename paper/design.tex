\section{Design of the \name file transfer system}%
\label{design}
\sonja{will frame and structure (A) squad overlay (prediction) (B)
  global overlay (RPS) (C) sphinxes (incl.\ sphinx, onion routing in
  general) (D) SPOR and SPORES (E) encryption (hybrid, payload, header)
  if not included earlier (F) out-of-band}
\commentDaniel{I suggest the following structure:
  (A) Sphinxes
  (B) SPOR (global overlay)
  (C) SPORES (local overlay).
  My original idea was to make Sphinxes its own section before the design 
  section instead of a subsection in the design section.}
\sonja{remove/update references to building blocks, POR}
\commentDaniel{I removed the building blocks subsection entirely.}

Our goal is to enable private and reliable file exchange between users 
participating in the system, by using their respective devices only.
When Alice and Bob, two users of our system, want to exchange a file \(f\) 
through \name; they start by sharing some information out-of-band, \eg from 
their smartphones.
More precisely, they exchange metadata on \(f\), encryption keys, and exchange 
use-once reply mix-headers.
They use these reply headers to transfer the file contents of \(f\) over a 
network of unreliable nodes while also achieving privacy.

\begin{figure}[t]
  \centering
  \def\svgwidth{0.8\columnwidth}
  \import{figures/}{outline.pdf_tex}
  \caption{\label{fig:outline}%
    \commentDaniel{We must adapt this figure to the text.}
    Outline of \name's components. Users squads of devices are circled in gray. 
    From top to bottom: a user's devices collaborate through the Squad Overlay 
    (\cref{sec:squad_overlay}); online devices globally share information about 
    them to random peers (\cref{sec:global_overlay}); using the two above 
    overlays allows for the creation of \ac{SPOR} between sets of devices. 
    These protocols enables secure file transfer between users 
    (\cref{SPORES}).}
\end{figure}

This section presents the different parts of the system in detail.
We align the presentation of the system with the taxonomy of 
\textcite{RoutingSurveyAnonymousProtocols}.
They categorize anonymous communication protocols using the following 
categories (see~\cite[Table 1]{RoutingSurveyAnonymousProtocols}):
\begin{description}
  \item[Network structure]
    This describes the characteristics of the anonymous relays, the connections 
    between them and the underlying topology.
    The subcategories are
    \begin{enumerate*}
      \item network topology,
      \item connection type (direction, synchronization),
      \item symmetry (node roles, node topology for routing, decentralization).
    \end{enumerate*}

  \item[Routing information]
    This describes the network information available to entities deciding on 
    the route of an anonymous connection.
    The subcategories are
    \begin{enumerate*}
      \item network view necessary for making routing decisions,
      \item triggers for routing information updates.
    \end{enumerate*}

  \item[Communication model]
    This describes the entities that make the routing decisions and how they 
    make these decisions.
    The subcategories are
    \begin{enumerate*}
      \item routing type (who selects nodes per route),
      \item scheduling (traffic prioritization),
      \item node selection (determinism, selection set, selection probability).
    \end{enumerate*}

  \item[Performance]
    This describes things like latency and communication mode.
    The subcategories are
    \begin{enumerate*}
      \item protocol latency,
      \item communication mode (connection- or message-based).
    \end{enumerate*}
\end{description}

We first describe Sphinxes (\cref{Sphinxes}), which is an adaptation of the 
Sphinx~\cite{Sphinx} mix-header format.
This means that we inherit some properties from Sphinx and due to being only a 
header format, it only imposes some restrictions in the above categories.
Sphinxes provides, just as Sphinx, source-routed (communication model), 
unidirectional (network structure), message-based (performance) communication.
As such, it relies on a flat routing-topology (network structure) with fair 
scheduling (communication model) --- as all packets are indistinguishable they 
must be processed on a first-in-first-out basis.
Sphinxes also introduces some probability to the node selection, but this is 
only a probabilistic selection among already selected nodes and only 
interesting against passive adversaries (an active adversary can learn the 
entire set).

Sphinxes does \emph{not} introduce any restrictions on whether the network 
topology must be fully connected or not, be asynchronous (as in Tor) or 
synchronous (as in mix-nets), whether node selection must be uniformly random 
or not.
Just as Sphinx, it can be used in many different settings.

Next, we describe the \ac{SPOR} protocol (\cref{SPOR}).
This focuses on the node selection, \ie adds node selection on top of Sphinxes.
The \ac{SPOR} protocol assumes a source of random nodes, \eg through 
\ac{RPS}~\cite[\eg][]{} or \iac{DHT} based scheme~\cite[\eg][]{}.
Each node must be associated with a public key and some availability 
prediction.
\Ac{SPOR} selects nodes for a route uniformly randomly and uses the 
availability to maximize the availability of the entire route, \ie across 
layers.
As \ac{SPOR} assumes this source of random nodes, the network view (routing 
information) of each node depends on this source of random nodes, as does the 
fact of how decentralized the scheme becomes and whether the network toppology 
is fully, mostly or partly connected (network structure).
As \ac{SPOR} is designed, it selects nodes uniformly among all the nodes 
(communication model, node selection) that the source of random nodes provides.
Thus, ultimately, these also depends on the source of random nodes.

Finally, we describe the complete \ac{SPORES} protocol (\cref{SPORES}).
\Ac{SPORES} adds an e-squad protocol to \ac{SPOR}.
This protocol provides provides each device in the e-squad of a user with 
prediction of its own and the other devices' availability.
This availability can then be used by the devices in the e-squad to participate 
as nodes for the routing of \ac{SPOR}, \ie making it \iac{P2P} system (network 
structure).

\Ac{SPORES} also allows the e-squad to act as one autonomous system, rather 
than several.
In particular, the devices will exchange information so that one device can 
receive an expected message on the behalf of another device, \eg while it is 
offline.

\include*{sphinxes}
\include*{global-overlay-design}
\include*{squad-overlay-design}
\include*{file-exchange-design}
